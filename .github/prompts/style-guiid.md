# Terraform コーディングガイド

このガイドは Terraform コードを書く際の標準的なスタイルと規約を定めたものです。明確で読みやすく、慣用的な Terraform コードを書くための指針となります。

## 基本方針

HashiCorp の公式 Terraform スタイルガイドに準拠します。これは`terraform fmt`コマンドによって強制されます。すべての Terraform リポジトリでは pre-commit フックを使用してこれを適用してください。

## 追加の規約

### 全般

#### インデントは 2 スペース

ブロックの内容は 2 スペースでインデントします。

#### 120 文字の行制限

行の長さは 120 文字を上限とします。ただし、`variable`と`output`ブロックの`description`文字列は例外とし、1 行での記述を推奨します。

#### ブロックラベル、変数、出力はスネークケース

ブロックのラベルはスネークケースにします。例えば、`example_instance`を使用し、`ExampleInstance`や`example-instance`は使用しません。

例:

```hcl
resource "aws_instance" "example_instance" {
  # 省略
}

variable "vpc_id" {}
output "instance_name" {}
```

#### モジュールフォルダ規約

各モジュールリポジトリは以下の 3 つのフォルダを持つべきです：

- `modules`: ユーザーが利用するための Terraform モジュール
- `examples`: `modules`フォルダのモジュールの使用例を示す Terraform モジュール
- `test`: リポジトリのコードをテストするための Terratest の Go ファイル

また、`modules`内の各モジュールは以下のファイルで構成します：

- `variables.tf`: すべての`variable`ブロック（入力を指定）
- `outputs.tf`: すべての`output`ブロック（出力を指定）
- `main.tf`: その他のロジック
- `dependencies.tf`（オプション）: `data`ソースブロックによって取得される外部参照

#### `variables.tf`の規約

各変数ブロックは常に`description`と`type`を定義し、その順序で記述します：

```hcl
variable "example" {
  description = "これは例です"
  type        = string
  default     = "example"  # 注: これはオプション
}
```

##### 複合型

自由形式のマップよりも具体的なオブジェクト型を優先します。ただし、特に大きなオブジェクトではオプション属性のサポートが有用です。

#### `outputs.tf`の規約

各出力ブロックは常に`description`を`value`の前に定義します：

```hcl
output "greeting" {
  description = "これは挨拶メッセージです"
  value       = "hello world!"
}
```

#### `main.tf`の規約

`main.tf`はコンポーネントに対応するセクションで（緩やかに）構成します。各セクションはモジュールの特定のコンポーネントに焦点を当てる必要があります。

セクションの順序付けに標準はありませんが、以下のセクションを最初に配置します：

1. モジュールのバージョン制約
2. 必要に応じて Provider ブロック
3. モジュールの主要コンポーネント
4. その他のすべてのセクション
5. `data`ブロック（最後に配置）

#### 条件式

条件式を複数行に分ける場合は`()`を使用します：

```hcl
locals {
  elb_id = (
    var.elb_already_exists
    ? var.elb_id
    : module.elb.elb_id
  )
}
```

### コメント

#### `#`を`//`より優先

コメント文字列には`#`を使用し、`//`や`/**/`は使用しません。

#### `# -`を`# ~`より優先

セクションヘッダーのコメントブロックの区切りには`# ----`を使用し、`# \~~~~`は使用しません。

#### `variables.tf`

`variables.tf`ファイルでは、必要な環境変数を明確に示し、ブロックコメントを使用して必須変数とオプション変数（デフォルト値あり）を分けます。

例:

```hcl
# ---------------------------------------------------------------------------------------------------------------------
# 環境変数
# これらのシークレットを環境変数として定義します
# ---------------------------------------------------------------------------------------------------------------------

# TF_VAR_master_password

# ---------------------------------------------------------------------------------------------------------------------
# モジュールパラメータ
# これらの変数はオペレーターによって渡されることが期待されます
# ---------------------------------------------------------------------------------------------------------------------

variable "required_var" {
  description = "このリソースを作成するためには、この変数を設定する必要があります"
  type        = string
}

# ---------------------------------------------------------------------------------------------------------------------
# オプションパラメータ
# これらの変数にはデフォルト値があり、オーバーライドできます
# ---------------------------------------------------------------------------------------------------------------------

variable "optional_var" {
  description = "この変数には適切なデフォルト値があるため、明示的に設定する必要はありません"
  type        = string
  default     = "Hello world"
}
```

#### `main.tf`

##### セクションコメント

`main.tf`の各セクションには、そのセクションで管理されるコンポーネントを説明するブロックコメントを含める必要があります。

例:

```hcl
# ---------------------------------------------------------------------------------------------------------------------
# このセクションで管理されているものを説明する一行の要約（大文字）
# 残りのコメントは標準的な大文字小文字を使用します。このセクションには管理されているコンポーネントの全体的な説明と、
# 非従来型の回避策や構成があれば、それを強調します。
# ---------------------------------------------------------------------------------------------------------------------
```

## 命名規則

1. リソース名はスネークケースを使用
2. 変数名は明確で、目的を示す名前にする
3. モジュール名はその機能を明確に示す

## ベストプラクティス

1. 各モジュールには適切な README を提供する
2. コードの重複を避ける
3. ハードコードされた値の代わりに変数を使用する
4. すべての必須変数に明確な説明を提供する
5. セキュリティリスクを最小限に抑えるための適切な設計を行う
